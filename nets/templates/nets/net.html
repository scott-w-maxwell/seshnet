{% extends 'nets/base.html' %}
{% load crispy_forms_tags %}

{% block content %}

<head>
    <title>{{net_name}}</title>

    <style>
      div.chat-log {
        background-color:;
        max-height: 100%;
        height: 600px;
        overflow-x: hidden;
        overflow-y: auto;
        text-align: left;
      }


      input.chat-message-input{
        width: 95%;
      }

    </style>
</head>


<body style="background-color:#111;">

    <div class='row m-0'>

        <!-- Buffer to center content -->
        <div class='col-sm-2 main_wrap' style="overflow: hidden;"></div>


        <!-- Centered Content -->
        <div class='col-sm-8' style="overflow: hidden; color:white; background-color:#111;">


            <div class="p-3 mb-2 bg-dark text-light">

            <div class="chat-log" id="chat-log"></div>

                <input class="chat-message-input" id="chat-message-input" type="text" style="border-radius:4px; bottom:0; background-color:#111; border-color:#626263; color:white;">                
                    <button id="chat-message-submit" type="button" style="border-radius:4px; border: 0; background-color:#; position:fixed; margin-top:2px;">
                        <i class="icon-chevron-right"></i>
                    </button>
                </input>


            </div>    

        </div>


        <!-- Buffer to center content -->
        <div class='col-sm-2'></div>

    </div>
</body>

{{ net_id|json_script:"net-id" }}


<script src="https://cdnjs.cloudflare.com/ajax/libs/reconnecting-websocket/1.0.0/reconnecting-websocket.js" integrity="sha512-SxQulwFs2B38bmUJtBSo9tD07MDrtCbY8me3AOZ14tRknCPTeMDLvCQV4ekhs8R0o9QPnW5HQanKfveexVcwLA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script>


    function loadImage() {
       objDiv.scrollTop = objDiv.scrollHeight;
    }

    var objDiv = document.getElementById("chat-log");


    // scrolls to bottom of chat log when loading the page
    window.onload=function () {
        var objDiv = document.getElementById("chat-log");
        objDiv.scrollTop = objDiv.scrollHeight;
    }


    // Display older messages
    {% for message in messages %}
        document.getElementById('chat-log').innerHTML += '<small>{{ message.author }}</small><small> @{{ message.date_sent }}</small><br>'
        document.getElementById('chat-log').innerHTML += '{{ message.content|urlize}}';
        document.getElementById('chat-log').innerHTML += '<hr style="opacity:5%;">'
    {% endfor %}


    const netID = JSON.parse(document.getElementById('net-id').textContent);

    console.log(netID);

    const chatSocket = new ReconnectingWebSocket(
        'ws://'
        + window.location.host
        + '/ws/net/'
        + netID
        + '/'
    );

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        document.getElementById('chat-log').innerHTML += ('<small>' + 'Usernamegoeshere' + '</small><small> @' + data.date_sent + '</small><br>')
        document.getElementById('chat-log').innerHTML += (data.message + '<br>');
        document.getElementById('chat-log').innerHTML += '<hr>';

        // On-send, scroll to bottom of chat-log
        objDiv.scrollTop = objDiv.scrollHeight;
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function(e) {
        if (e.keyCode === 13) {  // enter, return
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function(e) {
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;
        chatSocket.send(JSON.stringify({
            'message': message,
            'user_id': '{{ user.id }}',
            'net_id': '{{ net_id }}'
        }));
        messageInputDom.value = '';

        objDiv.scrollTop = objDiv.scrollHeight;
    };
</script>

{% endblock content %}